#!/usr/bin/with-contenv bash

#======================================================================================================================
# Run checks
#======================================================================================================================

source ${INC}/check.sh


#======================================================================================================================
# Require source files
#======================================================================================================================

source ${INC}/replace.sh
source ${INC}/setup-global.sh
source ${INC}/setup-nginx.sh
source ${INC}/setup-ssl.sh


#======================================================================================================================
# Set up global SSL configuration
#======================================================================================================================

_echo "Setting up getssl environment..."
setup_global
_done


#======================================================================================================================
# Set up Nginx and SSL for each primary domain
#======================================================================================================================

_echo "Setting up domains..."
for D in "${!DOMAINS[@]}" ; do
    _echo " - ${D}"
    U=${DOMAINS[$D]}        # upstream server
    A=(${ALIASES[${D}]})    # domain aliases
    setup_nginx ${D} ${U} A
    setup_ssl ${D} A
    _ok " - ${D} done."
done
_done


#======================================================================================================================
# Request certificates
#======================================================================================================================

[[ "${SSL_REQUEST_ON_STARTUP}" == "1" ]] && ssl-request
