#!/usr/bin/with-contenv bash

#======================================================================================================================
# Ensure email is set
#======================================================================================================================

if [ -z "${LETS_ENCRYPT_EMAIL}" ] ; then
    echo " - LETS_ENCRYPT_EMAIL must be set to install acme.sh."
    exit 1
fi


#======================================================================================================================
# If it has already been installed, exit
#======================================================================================================================

HOME=/etc/acme.sh
if [ -f ${HOME}/acme.sh ] ; then
    echo " - acme.sh is already installed."
    exit 0
fi


#======================================================================================================================
# Download acme.sh
#======================================================================================================================

cd ${HOME}

URL="https://raw.githubusercontent.com/Neilpang/acme.sh/master/acme.sh"
echo " - downloading ${URL}..."
wget -O acme.sh ${URL}
echo " - done."


#======================================================================================================================
# Install acme.sh
#======================================================================================================================

echo " - installing acme.sh..."
./acme.sh --install  \
    --home ${HOME} \
    --config-home ${HOME}/data \
    --cert-home /etc/ssl/certs \
    --accountemail "${LETS_ENCRYPT_EMAIL}"
echo " - done."
