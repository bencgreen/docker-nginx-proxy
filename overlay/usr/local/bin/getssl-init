#!/usr/bin/with-contenv bash

#======================================================================================================================
# Ensure email is set
#======================================================================================================================

if [ -z "${LETS_ENCRYPT_EMAIL}" ] ; then
    echo " - LETS_ENCRYPT_EMAIL must be set before requesting SSL certificates."
    exit 1
fi


#======================================================================================================================
# Define directories
#======================================================================================================================

SSL=/ssl
SSL_CERTS=${SSL}/certs
SSL_CONF=${SSL}/conf
NGINX_SITES=/sites

[[ ! -d ${SSL_CERTS} ]] && mkdir ${SSL_CERTS}
[[ ! -d ${SSL_CONF} ]] && mkdir ${SSL_CONF}


#======================================================================================================================
# Create arrays and include configuration
#======================================================================================================================

SSL_CONF_SITES=${CONF}/sites.sh
if [ ! -f ${SSL_CONF_SITES} ] ; then
    echo " - you must create ${SSL_CONF_SITES} - see ssl-conf-sites-sample.sh."
    exit 1
fi

declare -A DOMAINS
declare -A ALIASES

source ${SSL_CONF_SITES}


#======================================================================================================================
# Check whether or not domains have been registered
#======================================================================================================================

if [ "${#DOMAINS[@]}" = "0" ] ; then
    echo " - no domains have been registered for SSL."
    exit 1
fi


#======================================================================================================================
# Setup each primary domain
#======================================================================================================================

echo " - creating configuration..."
for D in "${!DOMAINS[@]}" ; do
    echo " - domain ${D}..."
    touch ${NGINX_SITES}/${D}
    getssl -w ${SSL_CERTS} -d -c ${D}
done
echo " - done."
