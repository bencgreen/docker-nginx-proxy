#!/usr/bin/with-contenv bash

#======================================================================================================================
# Run checks
#======================================================================================================================

source /etc/functions/check.sh


#======================================================================================================================
# Set up Nginx and SSL for each primary domain
#======================================================================================================================

source /etc/functions/replace.sh
source /etc/functions/setup-nginx.sh
source /etc/functions/setup-ssl.sh

echo " - setting up domains..."
for D in "${!DOMAINS[@]}" ; do
    echo " - ${D}..."
    U=${DOMAINS[$D]}        # upstream server
    A=(${ALIASES[${D}]})    # domain aliases
    setup_nginx ${D} ${U} A
    setup_ssl ${D} A
done
echo " - done."


#======================================================================================================================
# Request certificates
#======================================================================================================================

if [ "${SSL_REQUEST_ON_STARTUP}" = "1" ] ; then
    request
fi
